<!DOCTYPE html>
<html>
<head>
  <title>Roeselare Neerslag – Twee Kaarten</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; }
    #input-map, #heatmap-map {
      height: 400px;
      width: 100%;
      margin-top: 20px;
    }
    h2 { margin-top: 30px; }
  </style>
</head>
<body>

  <h2>Geef je neerslag door</h2>
  <p>Klik op de kaart en voer de neerslag van gisteren in (mm).</p>
  <div id="input-map"></div>

  <h2>Heatmap van alle metingen</h2>
  <div id="heatmap-map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxNsWmyc9Oha_jfECuFsHmyNrwAlxfXufi2OdOmewjahq2MLQY3m-UyXjr_aDbzy63E/exec";

    // =========================
    // INPUT-KAART
    // =========================
    var inputMap = L.map('input-map').setView([50.9480, 3.1163], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(inputMap);

    var inputMarker = null;
    inputMap.on('click', function(e) {
      if (inputMarker) {
        alert("Je kunt maar één meting per bezoek ingeven.");
        return;
      }

      var regen = prompt("Geef de neerslag van gisteren in (mm):");
      if (regen === null || regen === "" || isNaN(regen) || regen < 0 || regen > 200) {
        alert("Ongeldige invoer. Geef een getal tussen 0 en 200 mm.");
        return;
      }

      inputMarker = L.marker(e.latlng).addTo(inputMap);

      var datum = new Date().toISOString().split("T")[0];

      fetch(WEB_APP_URL, {
        method: "POST",
        body: new URLSearchParams({
          datum: datum,
          lat: e.latlng.lat,
          lng: e.latlng.lng,
          neerslag: regen
        })
      })
      .then(response => response.text())
      .then(text => {
        console.log("SERVER ANTWOORD:", text);
        if (text === "Success") {
          alert("Bedankt! Je neerslag is geregistreerd.");
          loadHeatmap(); // update heatmap-kaart
        } else {
          alert("Er ging iets mis: " + text);
          inputMap.removeLayer(inputMarker);
          inputMarker = null;
        }
      })
      .catch(error => {
        console.error("FETCH ERROR:", error);
        alert("Er ging iets mis bij het verzenden.");
        inputMap.removeLayer(inputMarker);
        inputMarker = null;
      });
    });

    // =========================
    // HEATMAP-KAART
    // =========================
    var heatMap = L.map('heatmap-map').setView([50.9480, 3.1163], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(heatMap);

    var heat = L.heatLayer([], { radius: 25, blur: 15, maxZoom: 17 }).addTo(heatMap);

    function loadHeatmap() {
      fetch(WEB_APP_URL)
        .then(response => response.json())
        .then(data => {
          var punten = data.map(d => [d.lat, d.lng, d.neerslag]);
          heat.setLatLngs(punten);
        })
        .catch(err => console.error("Kon data niet laden:", err));
    }

    loadHeatmap(); // initial load
  </script>

</body>
</html>
