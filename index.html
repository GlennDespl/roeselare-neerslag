<!DOCTYPE html>
<html>
<head>
  <title>Roeselare Neerslag</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 600px; width: 100%; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
  </style>
</head>
<body>
  <h2>Roeselare Neerslag – Geef je meting door</h2>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script>
    var map = L.map('map').setView([50.9480, 3.1163], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    // Heatmap layer
    var heat = L.heatLayer([], {radius: 25, blur: 15, maxZoom: 17}).addTo(map);

    // Functie om heatmap te laden
    function loadHeatmap() {
      fetch("https://script.google.com/macros/s/JE_APP_SCRIPT_ID/exec") // vervang met jouw Web App URL
        .then(resp => resp.json())
        .then(data => {
          var punten = data.map(d => [d.lat, d.lng, d.neerslag]);
          heat.setLatLngs(punten);
        })
        .catch(err => console.error("Kon data niet laden:", err));
    }

    loadHeatmap(); // initial load

    var marker;
    map.on('click', function(e) {
        if (!marker) {
            marker = L.marker(e.latlng).addTo(map);

            var regen = prompt("Geef de neerslag van gisteren in (mm):");
            if (regen != null && !isNaN(regen)) {
                var datum = new Date().toISOString().slice(0,10);
                fetch("https://script.google.com/macros/s/JE_APP_SCRIPT_ID/exec?datum=" + datum +
                      "&lat=" + e.latlng.lat +
                      "&lng=" + e.latlng.lng +
                      "&neerslag=" + regen)
                  .then(response => response.text())
                  .then(data => {
                      if(data === "Success") {
                          alert("Bedankt! Je neerslag is geregistreerd.");
                          loadHeatmap(); // heatmap bijwerken
                      } else {
                          alert("Er ging iets mis: " + data);
                          map.removeLayer(marker);
                          marker = null;
                      }
                  })
                  .catch(err => {
                      alert("Er ging iets mis bij het verzenden. Probeer later opnieuw.");
                      console.error(err);
                      map.removeLayer(marker);
                      marker = null;
                  });
            } else {
                alert("Ongeldige invoer. Probeer opnieuw.");
                map.removeLayer(marker);
                marker = null;
            }
        } else {
            alert("Je kunt slechts één locatie per dag aangeven. Verplaats de bestaande marker indien nodig.");
        }
    });
  </script>
</body>
</html>
